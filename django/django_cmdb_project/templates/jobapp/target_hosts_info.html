{% extends 'jobapp/base.html' %}
{% load staticfiles %}

{% block title_block %}
    Target Hosts Info
{% endblock %}

{% block main_block %}
	  <div style="margin-top:15px;">
		<h6 style="color: rgb(0, 132, 228)"><strong>[ {{appname}} - {{setname}} - {{modulename}} ]</strong></h6>
    <button id="AllSelect" class="btn btn-default" type="button">全选</button>
    <button id="RevSelect" class="btn btn-default" type="button">反选</button>
    <button id="HostsSelect" class="btn btn-default" type="button" href="#job_execute" data-toggle="modal">确认选取</button>
  
    </div>

     <div class="table-responsive">
        <table class="table table-striped table-condensed table-border">
            <thead>
                <tr align="center">
                    <td></td>
                    <td>ID</td>
                    <td>HOSTNAME</td>
                    <td>SYSTEM(BKING)</td>
                    <td>SYSTEM(SALT)</td>
                    <td>IP(BKING)</td>
                    <td>IP(SALT)</td>
                    <td>STATUS(SALT PING)</td>
                    <td>DETAIL</td>
                </tr>
            </thead>
            <tbody id="id_running_jobs_table">
            
            {% for host in hosts %}
                <tr align="center">
                    {% if host.status == 1 %}
                        <td><input name="target_host" value="{{host.HostName}}" type="checkbox"></td>
                    {% else %}
                        <td><input value="{{host.HostName}}" type="checkbox" disabled></td>
                    {% endif %}
                    <td>{{ forloop.counter }}</td>
                    <td>{{ host.HostName }}</td>
                    <td>{{ host.OSName }}</td>
                    <td>{{ host.osname_salt }}</td>
                    <td>{{ host.InnerIP }}</td>
                    <td>{{ host.ip_salt }}</td>
                    <td>
                    	{% if host.status == 1 %}
                    		<font color="green" data-toggle="tooltip" title="salt-minion is up"><strong>UP</strong></font>
                    	{% else %}
                    	    <font color="red" data-toggle="tooltip" title="salt-minion is down"><strong>DOWN</strong></font>
                    	{% endif %}
                    </td>
                    <td>
                        {% if host.status == 1 %}
                    		<a class="btn btn-outline-success my-2 my-sm-0"  role="button" id="{{host.HostName}}" name="host_detail_btn" href="#host_detail_info" data-toggle="modal">Detail</a>
                    	{% else %}
                            <a class="btn btn-outline-success my-2 my-sm-0 disabled" href="#" role="button">Detail</a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
           
            </tbody>
        </table>
    </div>


<!-- popup box start -->
    <div class="modal fade" id="host_detail_info" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title" id="myModalLabel1">主机详情</h6>
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          </div>
          <div class="modal-body" id="ShowHostInfoDiv">

          </div>
          <div class="modal-footer">
          </div>
        </div>
      </div>
   </div>
<!-- popup box end   --> 


<!-- popup box start -->
    <div class="modal fade" id="job_execute" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title" id="myModalLabel2">作业执行</h6>
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          </div>

          <div class="modal-body">

              <table class="table table-striped table-condensed table-border">
                <tr>
                  <td>目标:</td>
                  <td id="show_target_hosts"></td>
                </tr>
              </table>
    
              <!-- <div class="container"> -->

                  <ul class="nav nav-tabs nav-justified">
                      <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#StateSls">state.sls</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#CmdRun">cmd.run</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#">shell</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#">uploadfile</a>
                      </li>
                  </ul>
               
                  <div class="tab-content">

                    <div id="StateSls" class="tab-pane fade show active" role="tabpanel">

                        <table class="table table-striped table-condensed table-border" style="margin-top:15px;">
                            <tr>
                                 <td>函数:</td>
                                 <td>state.sls</td>
                            </tr>
                            <tr>
                                 <td style="vertical-align:middle;">动作:</td>
                                 <td>
                                    <select class="custom-select">
                                      <option selected> please select action !</option>
                                      <option value="1">初始化</option>
                                      <option value="2">清理垃圾</option>
                                      <option value="3">回收</option>
                                    </select>
                                 </td>
                            </tr>
                            <tr>
                              <td>
                                <button id="state_sls_btn" class="btn btn-primary btn-block">确认</button>
                              </td>
                              <td></td>
                            </tr>
                        </table>

                    </div>

                     <div id="CmdRun" class="tab-pane fade" role="tabpanel">

                        <table class="table table-striped table-condensed table-border" style="margin-top:15px;">
                            <tr>
                                 <td>函数:</td>
                                 <td>cmd.run</td>
                            </tr>
                            <tr>
                                 <td style="vertical-align:middle;">动作:</td>
                                 <td>
                                    <select class="custom-select">
                                      <option selected> please select cmd !</option>
                                      <option value="1">uptime</option>
                                      <option value="2">hostname</option>
                                      <option value="3">who</option>
                                    </select>
                                 </td>
                            </tr>

                            <tr>
                              <td>
                                <button id="cmd_run_btn" class="btn btn-primary btn-block">确认</button>
                              </td>
                              <td></td>
                            </tr>
                        </table>

                    </div>

                   </div>

              <!-- </div> -->


          </div>
          <div class="modal-footer">
          <!-- <button id="ConfirmExe" class="btn btn-primary btn-block">执行</button> -->
          </div>
        </div>
      </div>
   </div>
<!-- popup box end   --> 




  <script type="text/javascript">
    $(document).ready(function(){


      $('[name="host_detail_btn"]').click(function() {
        var hostname = $(this).attr("id")
        $.get('/jobapp/get_host_detail_info/',{hostname:hostname},function(data){
          $('#ShowHostInfoDiv').html(data)
        })
      })


      $('#AllSelect').click(function(){
          $('input[name="target_host"]').each(function() {
            $(this).prop("checked","checked");
          });
      })


      $('#RevSelect').click(function(){
          $('input[name="target_host"]').each(function() {
              if ($(this).prop("checked")) {
                  $(this).prop("checked",false);
              }
              else {
                  $(this).prop("checked","checked")
              }

        });
      })


      $('#HostsSelect').click(function(){
          var TargetHostsStr = ""

          $('input[name="target_host"]').each(function(){
            if ($(this).prop('checked')) {
              CheckboxVal = $(this).val()
              TargetHostsStr = TargetHostsStr + CheckboxVal + ","
            }
          })

          
          if (TargetHostsStr=="") {
             $('#show_target_hosts').html("<font color='red'><strong>请选取执行目标！</strong></font>")
             $('#ConfirmExe').hide()
          }
          else {
             TargetHostsStr = TargetHostsStr.substring(0,TargetHostsStr.length-1)
             $('#show_target_hosts').text(TargetHostsStr)
             $('#ConfirmExe').show()
          }
      })

    })
  </script>

{% endblock %}