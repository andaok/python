{% extends 'jobapp/base.html' %}
{% load staticfiles %}

{% block title_block %}
    show job execute
{% endblock %}

{% block main_block %}
<div id="show"></div>

<div class="table-responsive">
	<table class="table table-striped table-condensed table-border">
	    <tbody>
		<tr>
			<td id="jid" val="{{ jid }}">
			[ JID: {{ jid }} ]
			<a href="#">详情</a> |
            <a href="#">停止该job</a>
            &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
            {% if is_test %}
            <font color="red"><strong>[ 测试 ]</strong></font>
            {% endif %}
			</td>
		</tr>
		<tr>
			<td>
			[ 目标主机数: {{ target_hosts_num }} ]
			<a href="#">详情</a> 
			</td>
		</tr>
		<tr>
			<td>
			[ 已返回主机数: 15 ]
			<a href="#">详情</a> 
			</td>
		</tr>
		</tbody>
	</table>
</div>

<div class="table-responsive">
	<table class="table table-striped table-condensed table-border">
		<thead>
			<tr>
				<td>序号</td>
				<td>主机名</td>
				<td>状态</td>
				<td>详情</td>
			</tr>
		</thead>
		<tbody>
		{% for host in target_hosts_list %}
			<tr>
				<td>{{ forloop.counter }}</td>
				<td>{{ host }}</td>
				<td id="check" val="{{ host }}"><img src="{% static 'images/loading1.gif'%}"></td>
				<td>
					<a class="btn btn-outline-success my-2 my-sm-0 disabled"  role="button" id="{{jid}}:{{host}}" name="job_host_task_detail_btn" href="#job_host_task_detail_info" data-toggle="modal">Detail</a>
				</td>
			</tr>
		{% endfor %}
		</tbody>
	</table>
</div>

<script type="text/javascript">

		function IntervalCheck(jid){

			var jid = $("td#jid").attr("val")
			var hosts = ""

			$("td#check").each(function(){
				host = $(this).attr("val")
				hosts = hosts + host + ","

			})

           
			if (hosts == "") {
				//alert("no host le ")
				clearInterval(IntChkObj)
			} else {
                hosts = hosts.substr(0,hosts.length-1)
                $.getJSON('/jobapp/get_job_hosts_task_status/',{hosts:hosts,jid:jid},function(data,status){
                	if (data != "") {
                	    DataArray = eval(data)
                	    for (i in DataArray) {
                		   //$('#show').html(DataArray[i]['host'] + "," + DataArray[i]['status'])
                		   host = DataArray[i]['host']
                		   status = DataArray[i]['status']
                		   if (status == 0) {
                		   	  $("td[val="+host+"]").html("<font color='green'><strong>SUCCESS</strong></font>")
                		   } else {
                		   	  $("td[val="+host+"]").html("<font color='red'><strong>FAILURE</strong></font>")
                		   }
                		   $("td[val="+host+"]").removeAttr("id")
                	    }
                	}

                })
			}
		}


	$(document).ready(function(){
    
		IntChkObj=setInterval("IntervalCheck()",1000)
	})

</script>

{% endblock %}
